```{r}
#| echo: false

library(htmltools)

# Get parameters from the parent document
member <- rmarkdown::metadata

# Helper function to safely get parameter values with defaults
get_param <- function(param_name, default = "") {
  if (is.null(member[[param_name]])) {
    return(default)
  } else {
    return(member[[param_name]])
  }
}

# Extract member information
name <- get_param("title", NULL)
photo <- get_param("photo", "images/default.svg")
email <- get_param("email", "")
social_media <- get_param("social_media", list())
mission_paragraphs <- get_param("mission_statement", list())
research_interests <- get_param("research_interests", list())
publications <- get_param("publications", list())
links <- get_param("links", list())

# Extract position and faculty from memberships with priority rules
# Priority: 1) status: active > alumni, 2) membership type ordering
memberships <- get_param("memberships", list())
position <- ""
faculty <- ""

if (length(memberships) > 0) {
  # Define type priority order
  type_priority <- c("management", "staff", "advisory board", "scientific board", 
                     "special advisor", "lmu-individual", "fellow", "affiliate")
  
  # Separate active and alumni memberships
  active_memberships <- Filter(function(m) !is.null(m$status) && m$status == "active", memberships)
  alumni_memberships <- Filter(function(m) !is.null(m$status) && m$status == "alumni", memberships)
  
  # Helper to find best membership with position/faculty
  find_best_membership <- function(membership_list) {
    if (length(membership_list) == 0) return(NULL)
    
    # Sort by type priority
    sorted_memberships <- membership_list[order(sapply(membership_list, function(m) {
      idx <- match(m$type, type_priority)
      if (is.na(idx)) length(type_priority) + 1 else idx
    }))]
    
    # Return first membership with position or faculty/affiliation
    for (m in sorted_memberships) {
      if (!is.null(m$position) || !is.null(m$faculty) || !is.null(m$affiliation) || !is.null(m$title)) {
        return(m)
      }
    }
    return(sorted_memberships[[1]])
  }
  
  # Try active first, then alumni
  best_membership <- find_best_membership(active_memberships)
  if (is.null(best_membership)) {
    best_membership <- find_best_membership(alumni_memberships)
  }
  
  # Extract position (check both position and title fields)
  if (!is.null(best_membership)) {
    if (!is.null(best_membership$position) && best_membership$position != "") {
      position <- best_membership$position
    } else if (!is.null(best_membership$title) && best_membership$title != "") {
      position <- best_membership$title
    }
    
    # Extract faculty (check both faculty and affiliation fields)
    if (!is.null(best_membership$faculty) && best_membership$faculty != "") {
      faculty <- best_membership$faculty
    } else if (!is.null(best_membership$affiliation) && best_membership$affiliation != "") {
      faculty <- best_membership$affiliation
    }
  }
}

# Map platform names to Bootstrap icons
icon_map <- list(
  "bluesky" = "fa-brands fa-bluesky", 
  "linkedin" = "fa-brands fa-linkedin",
  "github" = "fa-brands fa-github",
  "orcid" = "fa-brands fa-orcid",
  "mastodon" = "fa-brands fa-mastodon",
  "scholar" = "fa-solid fa-graduation-cap",
  "researchgate" = "fa-brands fa-researchgate",
  "academia" = "fa-solid fa-book",
  "youtube" = "fa-brands fa-youtube",
  "instagram" = "fa-brands fa-instagram",
  "facebook" = "fa-brands fa-facebook"
)



# Order list items where required
order_strings <- function(x, known_order) {
  # Sorts x according to known_order, unknown items go to the end in their original order
  idx <- match(x, known_order)
  key <- ifelse(is.na(idx), length(known_order) + 1, idx)
  as.list(x[order(key, seq_along(x))])
}

# Order social media links
site_priorty <- c("LMU Profile", "Professional Profile", "Personal Website", "Professional Website")
links <- order_strings(links, site_priorty)

```